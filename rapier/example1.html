<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapier.js Robot Simulation</title>
    <style>
        body { margin: 0; overflow: hidden; background: #111; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="ui">
        <h3>Robot Control</h3>
        <input type="range" id="motorSlider" min="-3" max="3" step="0.1" value="0">
        <p>Adjust Motor Angle</p>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "@dimforge/rapier3d": "https://cdn.skypack.dev/@dimforge/rapier3d-compat"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import RAPIER from '@dimforge/rapier3d';

        async function run_simulation() {
            // 2. Initialize Rapier Physics (Wasm)
            await RAPIER.init();
            const gravity = { x: 0.0, y: -9.81, z: 0.0 };
            const world = new RAPIER.World(gravity);

            // 3. Basic Three.js Setup
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            camera.position.set(0, 2, 5);

            // 4. Create the Robot Parts
            // Base (Fixed)
            const groundBodyDesc = RAPIER.RigidBodyDesc.fixed().setTranslation(0, 0, 0);
            const groundBody = world.createRigidBody(groundBodyDesc);
            const groundColliderDesc = RAPIER.ColliderDesc.cuboid(1, 0.2, 1);
            world.createCollider(groundColliderDesc, groundBody);

            // Arm (Dynamic)
            const armBodyDesc = RAPIER.RigidBodyDesc.dynamic().setTranslation(0, 1.5, 0);
            const armBody = world.createRigidBody(armBodyDesc);
            const armColliderDesc = RAPIER.ColliderDesc.cuboid(0.2, 1, 0.2);
            world.createCollider(armColliderDesc, armBody);

            // 5. Create a Motorized Joint (The "Program")
            const params = RAPIER.JointData.revolute(
                { x: 0, y: 0, z: 0 },   // Anchor on Base
                { x: 0, y: -1, z: 0 },  // Anchor on Arm
                { x: 0, y: 0, z: 1 }    // Axis of rotation (Z)
            );
            const joint = world.createImpulseJoint(params, groundBody, armBody, true);
            
            // Visual Meshes for Three.js
            const boxGeo = new THREE.BoxGeometry(0.4, 2, 0.4);
            const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
            const armMesh = new THREE.Mesh(boxGeo, material);
            scene.add(armMesh);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(5, 5, 5);
            scene.add(light);

            // 6. UI Interaction
            const slider = document.getElementById('motorSlider');
            
            function gameLoop() {
                // Apply "Programmed" Motor Position
                const targetAngle = parseFloat(slider.value);
                joint.configureMotorPosition(targetAngle, 100, 10);

                world.step();

                // Sync Mesh to Physics Body
                const t = armBody.translation();
                const r = armBody.rotation();
                armMesh.position.set(t.x, t.y, t.z);
                armMesh.quaternion.set(r.x, r.y, r.z, r.w);

                renderer.render(scene, camera);
                requestAnimationFrame(gameLoop);
            }
            gameLoop();
        }

        run_simulation();
    </script>
</body>
</html>
